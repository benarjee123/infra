
## this works when approved 
trigger:
- main

pool:
  name: 'LinuxPool'

stages:
# -------------------------
# Stage 1: Terraform Init + Plan
# -------------------------
- stage: Plan
  displayName: Terraform Plan
  jobs:
  - job: PlanJob
    displayName: Plan Job
    steps:
    - checkout: self

    # Terraform Init
    - task: AzureCLI@2
      displayName: 'Terraform Init'
      inputs:
        azureSubscription: 'Azure-Testing-Connection'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          terraform init -input=false

    # Terraform Plan
    - task: AzureCLI@2
      displayName: 'Terraform Plan'
      inputs:
        azureSubscription: 'Azure-Testing-Connection'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          terraform plan -out=tfplan -input=false

# -------------------------
# Stage 2: Terraform Apply (APPROVAL HERE)
# -------------------------
- stage: Apply
  displayName: Terraform Apply
  dependsOn: Plan
  condition: succeeded()

  jobs:
  - deployment: ApplyJob
    displayName: Apply with Approval
    environment: dev   # ðŸ‘ˆ THIS TRIGGERS MANUAL APPROVAL
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Terraform Apply'
            inputs:
              azureSubscription: 'Azure-Testing-Connection'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                terraform apply -auto-approve tfplan
