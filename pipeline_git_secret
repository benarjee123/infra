## This code works when we want to use passwd from git secrets and terrform installed in self vm
trigger:
- main

pool:
  name: 'LinuxPool'

steps:
- checkout: self

# Optional: verify Terraform is available on self-hosted VM
- script: |
    terraform version
  displayName: 'Check Terraform Version'

# Terraform Init
- task: AzureCLI@2
  displayName: 'Terraform Init'
  inputs:
    azureSubscription: 'Azure-Testing-Connection'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
      cd infra
      terraform init -input=false

# Terraform Plan
- task: AzureCLI@2
  displayName: 'Terraform Plan'
  inputs:
    azureSubscription: 'Azure-Testing-Connection'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
      cd infra
      terraform plan -out=tfplan -input=false \
        -var="admin_username=azureuser" \
        -var="admin_password=$(VM_ADMIN_PASSWORD)"

# Terraform Apply
- task: AzureCLI@2
  displayName: 'Terraform Apply'
  inputs:
    azureSubscription: 'Azure-Testing-Connection'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
      cd infra
      terraform apply -auto-approve tfplan
