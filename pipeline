### This code used when we installed terraform in self host vm and secrtes in azure devops then we can use below code

trigger:
- main

pool:
  name: 'LinuxPool'

steps:
- checkout: self

# Fetch secret from Azure Key Vault
- task: AzureKeyVault@2
  displayName: 'Fetch VM password from Key Vault'
  inputs:
    azureSubscription: 'Azure-Testing-Connection'
    KeyVaultName: 'kv-testing-vm'
    SecretsFilter: 'vm-admin-password'
    RunAsPreJob: true

# Optional: verify Terraform exists on agent
- script: |
    terraform version
  displayName: 'Check Terraform Version'

# Terraform Init
- task: AzureCLI@2
  displayName: 'Terraform Init'
  inputs:
    azureSubscription: 'Azure-Testing-Connection'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
      cd infra
      terraform init -input=false

# Terraform Plan
- task: AzureCLI@2
  displayName: 'Terraform Plan'
  inputs:
    azureSubscription: 'Azure-Testing-Connection'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
      cd infra
      terraform plan -out=tfplan -input=false \
        -var="admin_username=azureuser" \
        -var="admin_password=$(vm-admin-password)"

# Terraform Apply
- task: AzureCLI@2
  displayName: 'Terraform Apply'
  inputs:
    azureSubscription: 'Azure-Testing-Connection'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
      cd infra
      terraform apply -auto-approve tfplan

